name: CI

# Lightweight CI for validation
# For rclgo: Run scripts/local-ci.sh before pushing (requires ROS environment)
# This CI only checks things that don't require ROS

on:
  pull_request:
    branches: [humble, jazzy, master]
  workflow_dispatch:

jobs:
  basic-checks:
    name: Basic Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Check code formatting
        run: |
          if [ -n "$(gofmt -l . | grep -v '.gen.go')" ]; then
            echo "âŒ Code needs formatting. Run: go fmt ./..."
            gofmt -l . | grep -v '.gen.go'
            exit 1
          fi
          echo "âœ… Code formatting OK"

      - name: Verify go.mod is tidy
        run: |
          go mod tidy
          if ! git diff --quiet go.mod go.sum; then
            echo "âŒ go.mod is not tidy. Run: go mod tidy"
            git diff go.mod go.sum
            exit 1
          fi
          echo "âœ… go.mod is tidy"

      - name: Check for common issues
        run: |
          # Check for debugging statements (excluding tests and generated code)
          if grep -r "fmt.Println" --include="*.go" --exclude="*_test.go" --exclude="*.gen.go" . ; then
            echo "âš ï¸  Found fmt.Println statements - please use proper logging"
            exit 1
          fi
          echo "âœ… No common issues found"

  label-pr:
    name: Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Determine distro from base branch
        id: distro
        run: |
          BASE_BRANCH="${{ github.base_ref }}"
          case "$BASE_BRANCH" in
            humble)
              echo "label=distro:humble" >> $GITHUB_OUTPUT
              ;;
            jazzy)
              echo "label=distro:jazzy" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "label=" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Add distro label
        if: steps.distro.outputs.label != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['${{ steps.distro.outputs.label }}']
            })

  reminder:
    name: Testing Reminder
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Comment reminder
        uses: actions/github-script@v7
        with:
          script: |
            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('scripts/local-ci.sh')
            );

            if (!botComment) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ¤– Testing Reminder

Before merging, ensure you've run local tests:

\`\`\`bash
# Source ROS environment
source /opt/ros/humble/setup.bash

# Run all local checks
./scripts/local-ci.sh

# Or test on all distros with Docker
./scripts/test-all-distros.sh
\`\`\`

This CI only runs basic checks. Full testing requires a ROS environment.`
              });
            }
